<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Compression Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .test-container {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .file-input {
            margin: 10px 0;
        }

        .preview {
            max-width: 300px;
            margin: 10px 0;
        }

        .progress {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <h1>Image Compression Test - Improved Version</h1>
    <p>This page tests the improved image compression functionality. Upload an image larger than 1MB to see it get
        compressed
        automatically.</p>
    <p><strong>New Features:</strong></p>
    <ul>
        <li>✅ Better handling of slightly bigger images</li>
        <li>✅ Dynamic dimension reduction when needed</li>
        <li>✅ More precise quality control</li>
        <li>✅ Automatic format optimization (PNG → JPEG)</li>
        <li>✅ Aggressive fallback compression</li>
        <li>✅ Better progress feedback</li>
    </ul>

    <div class="test-container">
        <h3>Test Image Upload</h3>
        <input type="file" id="testImage" accept="image/*" class="file-input">
        <div id="progress" class="progress" style="display: none;"></div>
        <div id="result" class="result" style="display: none;"></div>
        <button id="compressBtn" onclick="testCompression()" disabled>Compress Image</button>
        <div id="previewContainer">
            <h4>Original Image:</h4>
            <img id="originalPreview" class="preview" style="display: none;">
            <h4>Compressed Image:</h4>
            <img id="compressedPreview" class="preview" style="display: none;">
        </div>
    </div>

    <script src="imageCompression.js"></script>
    <script>
        let originalFile = null;
        let compressedFile = null;

        document.getElementById('testImage').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                originalFile = file;
                document.getElementById('compressBtn').disabled = false;

                // Show original image
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('originalPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        async function testCompression() {
            if (!originalFile) {
                alert('Please select an image first');
                return;
            }

            const progressDiv = document.getElementById('progress');
            const resultDiv = document.getElementById('result');
            const compressBtn = document.getElementById('compressBtn');

            progressDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            compressBtn.disabled = true;

            try {
                compressedFile = await window.imageCompressor.compressImage(originalFile, (progress) => {
                    progressDiv.innerHTML = `
                        <div>Compressing... ${window.imageCompressor.formatFileSize(progress.size)} / ${window.imageCompressor.formatFileSize(1024 * 1024)}</div>
                        <div>Quality: ${Math.round(progress.quality * 100)}% | Attempts: ${progress.attempts}</div>
                    `;
                });

                // Show compressed image
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('compressedPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(compressedFile);

                // Show results
                const originalSize = window.imageCompressor.formatFileSize(originalFile.size);
                const compressedSize = window.imageCompressor.formatFileSize(compressedFile.size);
                const reduction = Math.round(((originalFile.size - compressedFile.size) / originalFile.size) * 100);

                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>Compression Successful!</strong><br>
                        Original: ${originalSize}<br>
                        Compressed: ${compressedSize}<br>
                        Reduction: ${reduction}%
                    </div>
                `;
                resultDiv.style.display = 'block';

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>Compression Failed:</strong><br>
                        ${error.message}
                    </div>
                `;
                resultDiv.style.display = 'block';
            } finally {
                progressDiv.style.display = 'none';
                compressBtn.disabled = false;
            }
        }
    </script>
</body>

</html>